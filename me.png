ZnJvbSAgIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhCmltcG9ydCBsb2dnaW5nCmltcG9ydCBzb2NrZXQKZnJvbSAgIHN5cyBpbXBvcnQgZ2V0c2l6ZW9mCgojIHNldHVwIGxvZ2dpbmcKbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoX19uYW1lX18pCmxvZ2dlci5zZXRMZXZlbChsb2dnaW5nLkRFQlVHKQoKY2FjaGVfdGltZW91dHMgPSB7fQpjYWNoZV92YWx1ZXMgPSB7fQoKZGVmIF9nZXRfb3JfdGltZW91dChrZXkpOgogICAgIiIiCiAgICBSZXR1cm5zIGEga2V5IG9yIGNsZWFycyB0aW1lZCBvdXQga2V5LgoKICAgIG5jYWNoZS5jYWhjZV92YWx1ZXMgICBjb250YWlucyBrZXktPnZhbHVlICAgcGFpcnMKICAgIG5jYWNoZS5jYWNoZV90aW1lb3V0cyBjb250YWlucyBrZXktPnRpbWVvdXQgcGFpcnMKCiAgICBUaGVyZSBhcmUgdHdvIGZsYXZvdXJzIG9mIHRpbWVvdXQKICAgIDEuICgndHRsJywgIDx0dGwgZGF0ZXRpbWU+KQogICAgMi4gKCdwZXJtJywgPGNyZWF0ZWQgdGltZT4pCgogICAgU3BlY2lmaWNhdGlvbi4KCiAgICB8IGtleSB8IHRpbWVvdXQgdHlwZSB8ICAgIGRhdGUgICAgICB8ICBleHBlY3RlZCAgIHwKICAgICstLS0tLSstLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tKwogICAgfCdrMScgfCAgICAndHRsJyAgICAgfCBpbiBmdXR1cmUgICAgfCAgdmFsdWUgICAgICB8CiAgICB8J2syJyB8ICAgICd0dGwnICAgICB8IGluIHBhc3QgICAgICB8ICdOT1QgRk9VTkQnIHwKICAgIHwnazMnIHwgICAgJ3Blcm0nICAgIHwgaW4gcGFzdCAgICAgIHwgIHZhbHVlICAgICAgfAoKICAgIDpwYXJhbSBzdHIga2V5OiBBIGtleSBpbiB0aGUgdGltZW91dCBhbmQgdmFsdWUgY2FjaGVzLgogICAgIiIiCiAgICBleHBpcnkgPSBjYWNoZV90aW1lb3V0cy5nZXQoa2V5LCBOb25lKQogICAgdmFsdWUgPSBOb25lCiAgICBpZiBleHBpcnk6CiAgICAgICAgIyBXZSBmb3VuZCBhIHRpbWUgdG8gbGl2ZSBrZXkKICAgICAgICBpZiBleHBpcnlbMF0gPT0gJ3R0bCc6CiAgICAgICAgICAgICMgdHRsIGlzIGluIHRoZSBmdXR1cmUgb3IgZWxzZSB0aGUga2V5IHNob3VsZCBiZSBkZWxldGVkLgogICAgICAgICAgICBpZiBleHBpcnlbMV0gPiBkYXRldGltZS5ub3coKToKICAgICAgICAgICAgICAgIHZhbHVlID0gIGNhY2hlX3ZhbHVlcy5nZXQoa2V5LCBOb25lKQogICAgICAgIGVsc2U6ICMga2V5IGlzIHBlcm1hbmVudAogICAgICAgICAgICB2YWx1ZSA9IGNhY2hlX3ZhbHVlcy5nZXQoa2V5LCBOb25lKQogICAgaWYgdmFsdWUgaXMgTm9uZToKICAgICAgICAjIG5vIGtleSBjb3VsZCBiZSByZXR1cm5lZCBzbyBiZSBzdXJlIGJvdGggY2FjaGUgdGltZW91dHMgYW5kIGNhY2hlIHZhbHVlcyBhcmUgaW4gc3luYy4KICAgICAgICBjYWNoZV90aW1lb3V0cy5wb3Aoa2V5LCBOb25lKQogICAgICAgIGNhY2hlX3ZhbHVlcy5wb3Aoa2V5LCBOb25lKQogICAgICAgIHZhbHVlID0gJ05PVCBGT1VORCcKICAgIHJldHVybiB2YWx1ZQoKZGVmIF9jbGVhcl9wZXJtX2tleXMoY2h1bmtfc2l6ZSk6CiAgICAiIiIKICAgIENsZWFycyBhIGNodW5rIG9mIHRoZSBvbGRlc3QgcGVybSBrZXlzIHRvIGZyZWUgc3BhY2UuCgogICAgOnBhcmFtIGludCBjaHVua19zaXplOiBUaGUgbnVtYmVyIG9mIGtleXMgdG8gY2xlYXIuCiAgICAiIiIKICAgIGtleXMgPSBbKGtleSwgdmFsWzFdLCkgZm9yIGtleSwgdmFsIGluIGNhY2hlX3RpbWVvdXRzLml0ZXJpdGVtcygpIGlmIHZhbFswXSA9PSAncGVybSddCiAgICBrZXlzID0gc29ydGVkKGtleXMsIGtleT1sYW1iZGEgeDogeFsxXSwgcmV2ZXJzZT1GYWxzZSkKICAgIGtleXMgPSBrZXlzWzpjaHVua19zaXplXQogICAgZm9yIGtleSwgXyBpbiBrZXlzOgogICAgICAgIGNhY2hlX3RpbWVvdXRzLnBvcChrZXksIE5vbmUpCiAgICAgICAgY2FjaGVfdmFsdWVzLnBvcChrZXksIE5vbmUpCgpkZWYgX2NsZWFyX3R0bF9rZXlzKGZ1dHVyZSk6CiAgICAiIiIKICAgIENsZWFycyBhbGwgdHRsIGtleXMgd2hvIGV4cGlyZSBiZWZvcmUgdGhlIGdpdmVuIGZ1dHVyZSBkYXRlLgoKICAgIDpwYXJhbSBkYXRldGltZS5kYXRldGltZSBmdXR1cmU6IEZ1dHVyZSBkYXRlIHVzZWQgdG8gZXhwaXJlIGtleXMuCiAgICAiIiIKICAgIGtleXMgPSBbKGtleSwgdmFsWzFdLCkgZm9yIGtleSwgdmFsIGluIGNhY2hlX3RpbWVvdXRzLml0ZXJpdGVtcygpIGlmIHZhbFswXSA9PSAndHRsJ10KICAgIGZvciBrZXksIGV4cGlyeSBpbiBrZXlzOgogICAgICAgIGlmIGV4cGlyeSA8IGZ1dHVyZToKICAgICAgICAgICAgY2FjaGVfdGltZW91dHMucG9wKGtleSwgTm9uZSkKICAgICAgICAgICAgY2FjaGVfdmFsdWVzLnBvcChrZXksIE5vbmUpCgpkZWYgX3NldF9rZXkoa2V5LCB2YWx1ZSwgdHRsPU5vbmUpOgogICAgIiIiCiAgICBTZXRzIGEga2V5IGluIGNhY2hlX3ZhbHVlcyBhbmQgY2FjaGVfdGltZW91dHMuCgogICAgOnBhcmFtIHN0ciBrZXk6IFRoZSBrZXkgd2UgYXJlIHNldHRpbmcuCiAgICA6cGFyYW0gc3RyIHZhbDogVGhlIHZhbHVlIHdlIGFyZSBzZXR0aW5nLgogICAgOnBhcmFtIGludCB0dGw6IFRoZSB0aW1lIHRvIGxpdmUgaW4gc2Vjb25kcy4gT3B0aW9uYWwuCiAgICAiIiIKICAgIGlmIHR0bCBpcyBub3QgTm9uZToKICAgICAgICBjYWNoZV90aW1lb3V0c1trZXldID0gKCd0dGwnLCBkYXRldGltZS5ub3coKSArIHRpbWVkZWx0YShzZWNvbmRzPXR0bCksKQogICAgZWxzZToKICAgICAgICBjYWNoZV90aW1lb3V0c1trZXldID0gKCdwZXJtJywgZGF0ZXRpbWUubm93KCksKQogICAgY2FjaGVfdmFsdWVzW2tleV0gPSB2YWx1ZQoKZGVmIHBhcnNlX2NvbW1hbmQoY29tbWFuZCk6CiAgICAiIiIKICAgIFBhcnNlcyBTRVQgYW5kIEdFVCBjb21tYW5kcy4gQmVoYXZpb3VyIG9mIHRoZSBzZXQgY29tbWFuZCBpcyByZXByZXNlbnRlZCBiZWxvdy4KCiAgICBTRVQgPEtFWV9OQU1FPiAiPFZBTFVFPiIgVFRMPTxpbnQ+CiAgICAgICAgLSBLZXkgbmFtZXMgQ0FOTk9UIGhhdmUgc3BhY2VzLiBUVEwgaXMgb3B0aW9uYWwuCgogICAgR0VUIDxLRVlfTkFNRT4KICAgICAgICAtIEtleSBuYW1lcyBDQU5OT1QgaGF2ZSBzcGFjZXMKCiAgICB8ICAgY29tbWFuZCAgICAgICAgICAgICAgIHwgIEV4cGVjdGVkICAgICAgICAgICAgICB8CiAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rCiAgICB8IFNFVCBrMSAic29tZSB0ZXN0IGRhdGEiIHwgazEgLT4gInNvbWUgdGVzdCBkYXRhIiB8CiAgICB8IFNFVCBrMiAic29tZSB0ZXN0IGRhdGEiIHwgazIgLT4gInNvbWUgdGVzdCBkYXRhIiB8CiAgICB8IFNFVCBrMiAibW9yZSB0ZXN0IGRhdGEiIHwgazEgLT4gIm1vcmUgdGVzdCBkYXRhIiB8CiAgICB8IFNFVCBrMyBzb21lIHRlc3QgZGF0YSAgIHwgRXhjZXB0aW9uIC0gd3JvbmcgYXJncyB8CiAgICB8IFNFVCBrMyAibWUgIiBUVEw9MjAgICAgIHwgazMgLT4gIm1lICIgICAgICAgICAgICB8CiAgICB8IFNFVCBrNCAgICAgICAgICAgICAgICAgIHwgRXhjZXB0aW9uIC0gd3JvbmcgYXJncyB8CiAgICB8IEdFVCB0aGluZyAgICAgICAgICAgICAgIHwgTk9UIEZPVU5EICAgICAgICAgICAgICB8CiAgICB8IEdFVCBrMyAgICAgICAgICAgICAgICAgIHwgIm1lICIgICAgICAgICAgICAgICAgICB8CiAgICAiIiIKICAgICMgcHJlY2VlZGluZyBhbmQgdHJhaWxpbmcgc3BhY2VzIGFyZSByZW1vdmVkIGFuZCB0aGUgZW50aXJlIHN0cmluZyBpcyBzcGxpdCBvbiBzcGFjZXMuCiAgICBjb21tYW5kID0gY29tbWFuZC5sc3RyaXAoJyAnKS5yc3RyaXAoJyAnKS5zcGxpdCgnICcpCgogICAgIyBBIEdFVCBjb21tYW5kIGNhbiBvbmx5IGJlIGZvbGxvd2VkIGJ5IGEgS0VZCiAgICBpZiBjb21tYW5kWzBdLmxvd2VyKCkgPT0gJ2dldCc6ICMgY2FzZSBpbnNlbnNpdGl2ZQogICAgICAgIGlmIGxlbihjb21tYW5kKSA9PSAyOgogICAgICAgICAgICByZXR1cm4gX2dldF9vcl90aW1lb3V0KGNvbW1hbmRbMV0pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignRVJST1I6IFdyb25nIG51bWJlciBvZiBhcmdzIGZvciBHRVQuIFJlY2VpdmVkIHswfSwgZXhwZWN0ZWQgMicuZm9ybWF0KGxlbihjb21tYW5kKSkpCiAgICAjIEEgU0VUIGNvbW1hbmQgY2FuIGJlIGZvbGxvd2VkIGJ5IGEgS0VZLCB0aGVuIGEgVkFMVUUgYW5kIGZpbmFsbHkgYW4gb3B0aW9uYWwgVFRMCiAgICBlbGlmIGNvbW1hbmRbMF0ubG93ZXIoKSA9PSAnc2V0JzogIyBjYXNlIGluc2Vuc2l0aXZlCiAgICAgICAgIyBEbyB3ZSBoYXZlIGF0IGxlYXN0IHRoZSByaWdodCBudW0gb2YgcGFyYW1zPwogICAgICAgIGlmIGxlbihjb21tYW5kKSA+IDI6CiAgICAgICAgICAgICMgcGFyc2Ugb3V0IHRoZSB0dGwKICAgICAgICAgICAgdHRsID0gY29tbWFuZFstMV0ubG93ZXIoKQogICAgICAgICAgICBpZiB0dGwuc3RhcnRzd2l0aCgndHRsPScpIGFuZCB0dGxbNDpdLmlzZGlnaXQoKToKICAgICAgICAgICAgICAgIGNvbW1hbmQgPSBbY29tbWFuZFswXSwgY29tbWFuZFsxXSwgJyAnLmpvaW4oY29tbWFuZFsyOi0xXSksIGNvbW1hbmRbLTFdXQogICAgICAgICAgICAgICAgdHRsID0gaW50KHR0bFs0Ol0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb21tYW5kID0gW2NvbW1hbmRbMF0sIGNvbW1hbmRbMV0sICcgJy5qb2luKGNvbW1hbmRbMjpdKV0KICAgICAgICAgICAgICAgIHR0bCA9IE5vbmUKCiAgICAgICAgICAgICMgZXhhbWluZSB0aGUgdmFsdWUgYW5kIHJlbW92ZSBlbmNhcHN1bGF0aW5nIHF1b3RlcyBtZXNzCiAgICAgICAgICAgIGlmIGNvbW1hbmRbMl1bMF0gPT0gJyInIGFuZCBjb21tYW5kWzJdWy0xXSA9PSAnIic6CiAgICAgICAgICAgICAgICBjb21tYW5kID0gY29tbWFuZCA9IFtjb21tYW5kWzBdLCBjb21tYW5kWzFdLCBjb21tYW5kWzJdWzE6LTFdXQoKICAgICAgICAgICAgX3NldF9rZXkoY29tbWFuZFsxXSwgY29tbWFuZFsyXSwgdHRsPXR0bCkKICAgICAgICAgICAgcmV0dXJuICdTVUNDRVNTJwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ0VSUk9SOiBXcm9uZyBudW1iZXIgb2YgYXJncyBmb3IgU0VULiBSZWNlaXZlZCB7MH0sIGV4cGVjdGVkIDInLmZvcm1hdChsZW4oY29tbWFuZCkpKQogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdFUlJPUjogVW5rb3duIGNvbW1hbmQuIE5vdCBHRVQgb3IgU0VUJykKCmRlZiBtYW5hZ2VfbWVtb3J5KGNodW5rX3NpemUsIHN0ZXBfc2Vjb25kcywgbGltaXQpOgogICAgIiIiCiAgICBNYW5hZ2UgdGhlIHNpemUgb2YgdGhlIGNhY2hlIGJ5IGZpcnN0IHJlbW92aW5nIHRoZSBvbGRlc3QgcGVybSBrZXlzLgogICAgSWYgdGhhdCBmYWlscyB0byByZWR1Y2UgdGhlIGNhY2hlIHNpemUgdGhlbiB0dGwga2V5cyB0aGF0IHdpbGwgZXhwaXJlIGJlZm9yZQogICAgbm93ICsgc3RlcF9zZWNvbmRzIHdpbGwgYmUgcmVtb3ZlZC4gIFN0ZXBfc2Vjb25kcyBpcyBpbmNyZW1lbnRlZCB0byBrZWVwCiAgICByZW1vdmluZyBrZXlzIHVudGlsIHRoZSBsaW1pdCBpcyByZXNwZWN0ZWQuCgogICAgOnBhcmFtIGludCBjaHVua19zaXplOiBUaGUgbnVtYmVyIG9mIHBlcm0ga2V5cyB0byByZW1vdmUuCiAgICA6cGFyYW0gaW50IHN0ZXBfc2Vjb25kczogVGhlIGluY3JlbWVudCBzdGVwcyBpbiBzZWNvbmRzIGZvciByZW1vdmluZyB0dGwga2V5cy4KICAgIDpwYXJhbSBpbnQgbGltaXQ6IFRoZSBjYWNoZSBzaXplIGxpbWl0IGluIGJ5dGVzLgogICAgIiIiCiAgICAjIHJlY29yZCB0aGUgY2FjaGUgc2l6ZSBpbiBieXRlcyBhbmQgdGhlIHR0bCBzdGVwIGluIHNlY29uZHMKICAgIG9sZF9jYWNoZV9zaXplID0gY3VycmVudF9jYWNoZV9zaXplKCkKICAgIHRoaXNfc3RlcCA9IHN0ZXBfc2Vjb25kcwoKICAgICMgV2hpbGUgdGhlIGNhY2hlIGlzIG92ZXIgdGhlIHRvbGVyYW5jZSBsaW1pdAogICAgd2hpbGUgY3VycmVudF9jYWNoZV9zaXplKCkgPiBsaW1pdDoKCiAgICAgICAgIyBHZXQgcmlkIG9mIHRoZSBvbGRlc3QgcGVybSBrZXlzCiAgICAgICAgX2NsZWFyX3Blcm1fa2V5cyhjaHVua19zaXplKQoKICAgICAgICAjIElmIHRoZSBjYWNoZSBzaXplIGhhcyBub3QgY2hhbmdlZCB0aGVtIGFsbCB0aGUgcGVybSBrZXlzIGhhdmUgYmVlbiByZW1vdmVkCiAgICAgICAgaWYgY3VycmVudF9jYWNoZV9zaXplKCkgPT0gb2xkX2NhY2hlX3NpemU6CiAgICAgICAgICAgICMgU28gd2hpbGUgdGhlIGNhY2hlIGlzIG92ZXIgdGhlIHRvbGVyYW5jZSBsaW1pdAogICAgICAgICAgICB3aGlsZSBjdXJyZW50X2NhY2hlX3NpemUoKSA+IGxpbWl0OgogICAgICAgICAgICAgICAgIyBzdGFydCByZW1vdmluZyB0dGwga2V5cyB0aGF0IHdpbGwgaW4gZXhwaXJlIGluIHRoaXNfc3RlcCB3b3J0aCBvZiBzZWNvbmRzCiAgICAgICAgICAgICAgICBfY2xlYXJfdHRsX2tleXModGhpc19zdGVwKQogICAgICAgICAgICAgICAgIyBJbmNyZW1lbnQgdGhpc19zdGVwIHRvIGtlZXAgcmVtb3ZpbmcgbW9yZSBrZXlzIHVudGlsIHRoZSB0b2xlcmFuY2UgaXMgcHJlc2VydmVkLgogICAgICAgICAgICAgICAgdGhpc19zdGVwICs9IHN0ZXBfc2Vjb25kcwoKZGVmIGluaXRfc29ja2V0KGlwLCBwb3J0KToKICAgICIiIgogICAgRmFjdG9yeSByZXR1cm5zIGEgdGNwIHNvY2V0IGJvdW5kIHRvIGlwIGFuZCBwb3J0CgogICAgOnBhcmFtIHN0ciBpcDogaXBhZGRyZXNzIGZvciBzZXJ2aWNlIHRvIHJ1biBvbgogICAgOnBhcmFtIGludCBwb3J0OiBwb3J0IGZvciBzZXJ2aWNlIHRvIHJ1biBvbi4KICAgICIiIgogICAgcyA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX1NUUkVBTSkKICAgIHMuYmluZCgoaXAsIHBvcnQsKSkKICAgIHMubGlzdGVuKDEpCiAgICByZXR1cm4gcwoKY3VycmVudF9jYWNoZV9zaXplID0gbGFtYmRhIDogZ2V0c2l6ZW9mKGNhY2hlX3ZhbHVlcykgKyBnZXRzaXplb2YoY2FjaGVfdGltZW91dHMpCgpkZWYgcnVuX25jYWNoZShpcD0nMTI3LjAuMC4xJywgcG9ydD01MDA1LCBidWZmZXJfc2l6ZT0xMDI0LCBtYXhfbWVtb3J5PTE5MzMwMDAwMDAsCiAgICAgICAgICAgICAgIG1lbW9yeV90b2xlcmFuY2U9Ljk1LCBjbGVhcl9wZXJtX2NodW5rPTEsIGNsZWFyX3R0bF9zdGVwPTMwMCk6CiAgICAiIiIKICAgIENyZWF0ZXMgYW5kIGJpbmRzIHRvIGEgdGNwIHNvY2tldCB0byBsaXN0ZW4gZm9yIGNhY2hlIGNvbW1hbmRzLiAgQ2FsY3VsYXRlcwogICAgbWVtb3J5IGxpbWl0cy4gIExpc3RlbnMgZm9yIGFuZCBwYXJzZXMgbmV3IGNvbW1hbmRzLiAgUmV0dXJucyByZXNwb25zZXMuCgogICAgOnBhcmFtIHN0ciBpcDogVGhlIGlwIGFkZHJlc3MgdG8gYmluZCB0Y3Agc29ja2V0IHRvLgogICAgOnBhcmFtIGludCBwb3J0OiBUaGUgcG9ydCB0byBiaW5kIHRjcCBzb2NrZXQgdG8uCiAgICA6cGFyYW0gaW50IGJ1ZmZlcl9zaXplOiBSZWFkIHRoaXMgbnVtYmVyIG9mIGJ5dGVzIGZyb20gdGhlIHRjcCBidWZmZXIuIFNtYWxsZXIgY2FuIGJlIGZhc3Rlci4KICAgIDpwYXJhbSBpbnQgbWF4X21lbW9yeTogVGhlIG1lbW9yeSBsaW1pdCBpbiBieXRlcy4KICAgIDpwYXJhbSBmbG9hdCBtZW1vcnlfdG9sZXJhbmNlOiBQcmVjZW50YWdlIG9mIG1heF9tZW1vcnkgdGhhdCB3aWxsIGJlIG91ciBsaW1pdCwgd2UgbWF5IGdvIG92ZXIgYnJpZWZseS4KICAgIDpwYXJhbSBpbnQgY2xlYXJfcGVybV9jaHVuazogVGhlIG51bWJlciBvZiBwZXJtIGtleXMgdG8gcmVtb3ZlLgogICAgOnBhcmFtIGludCBjbGVhcl90dGxfc3RlcDogVGhlIGluY3JlbWVudCBzdGVwcyBpbiBzZWNvbmRzIGZvciByZW1vdmluZyB0dGwga2V5cy4KICAgICIiIgogICAgcyA9IGluaXRfc29ja2V0KGlwLCBwb3J0KQogICAgY29ubiwgYWRkciA9IHMuYWNjZXB0KCkKCiAgICBsb2dnZXIuaW5mbygiQ29ubmVjdGlvbiBBZGRyZXNzOiAlcyIsIGFkZHIpCgogICAgbGltaXQgPSBpbnQobWF4X21lbW9yeSptZW1vcnlfdG9sZXJhbmNlKQoKICAgIHdoaWxlIFRydWU6CiAgICAgICAgZGF0YSA9IGNvbm4ucmVjdihidWZmZXJfc2l6ZSkKICAgICAgICBpZiBub3QgZGF0YToKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0cnk6ICMgZXhlY3V0ZQogICAgICAgICAgICAjIyMgTWFuYWdlIG1lbW9yeSBiZWZvcmUgd2UgYWRkIG1vcmUga2V5cwogICAgICAgICAgICBtYW5hZ2VfbWVtb3J5KGNsZWFyX3Blcm1fY2h1bmssIGNsZWFyX3R0bF9zdGVwLCBsaW1pdCkKCiAgICAgICAgICAgICMjIyBQYXJzZSB0aGUgY29tbWFuZCBhbmQgcmV0dXJuIHRoZSByZXNwb25zZS4KICAgICAgICAgICAgcmVzcG9uc2UgPSBwYXJzZV9jb21tYW5kKGRhdGEpCiAgICAgICAgICAgIGNvbm4uc2VuZChyZXNwb25zZSkKCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3IgYXMgZToKICAgICAgICAgICAgIyMjIElmIGEgcGFyc2UgZXJyb3Igb2NjdXJlZAogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUpCiAgICAgICAgICAgIGNvbm4uc2VuZChzdHIoZSkpCiAgICBjb25uLmNsb3NlKCkK
ZnJvbSAgIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhCmZyb20gICBwbGF5Z3JvdW5kLm5pYWxsb2Muc3R1ZmYuZGltY3MgaW1wb3J0IG5jYWNoZQppbXBvcnQgdW5pdHRlc3QyIGFzIHVuaXR0ZXN0CgpjbGFzcyBUZXN0TkNhY2hlR2V0T3JUaW1lb3V0KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICIiIgogICAgbmNhY2hlLmdldF9vcl90aW1lb3V0IHdvcmtzIHRoZSBmb2xsb3dpbmcgd2F5LgoKICAgIG5jYWNoZS5jYWhjZV92YWx1ZXMgICBjb250YWlucyBrZXktPnZhbHVlICAgcGFpcnMKICAgIG5jYWNoZS5jYWNoZV90aW1lb3V0cyBjb250YWlucyBrZXktPnRpbWVvdXQgcGFpcnMKCiAgICBUaGVyZSBhcmUgdHdvIGZsYXZvdXJzIG9mIHRpbWVvdXQKICAgIDEuICgndHRsJywgIDx0dGwgZGF0ZXRpbWU+KQogICAgMi4gKCdwZXJtJywgPGNyZWF0ZWQgdGltZT4pCgogICAgU3BlY2lmaWNhdGlvbi4KCiAgICB8IGtleSB8IHRpbWVvdXQgdHlwZSB8ICAgIGRhdGUgICAgICB8ICBleHBlY3RlZCAgIHwKICAgICstLS0tLSstLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tKwogICAgfCdrMScgfCAgICAndHRsJyAgICAgfCBpbiBmdXR1cmUgICAgfCAgdmFsdWUgICAgICB8CiAgICB8J2syJyB8ICAgICd0dGwnICAgICB8IGluIHBhc3QgICAgICB8ICdOT1QgRk9VTkQnIHwKICAgIHwnazMnIHwgICAgJ3Blcm0nICAgIHwgaW4gcGFzdCAgICAgIHwgIHZhbHVlICAgICAgfAogICAgIiIiCgogICAgZGVmIHRlc3RfZ2V0X29yX3RpbWVvdXRfZnJlc2hfa2V5KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEluIHRoaXMgY2FzZSBhIGtleSBoYXMgYSB0aW1lIHRvIGxpdmUgaW4gdGhlIGZ1dHVyZSBhbmQgc2hvdWxkIHJldHVybiBkYXRhLgogICAgICAgICIiIgogICAgICAgIG5jYWNoZS5jYWNoZV90aW1lb3V0c1snVEVTVDEnXSA9ICgndHRsJywgZGF0ZXRpbWUubm93KCkgKyB0aW1lZGVsdGEoZGF5cz0xMCksKQogICAgICAgIG5jYWNoZS5jYWNoZV92YWx1ZXNbJ1RFU1QxJ10gPSAnc29tZSB0ZXN0IGRhdGEnCgogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdURVNUMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnc29tZSB0ZXN0IGRhdGEnKQoKICAgIGRlZiB0ZXN0X2dldF9vcl90aW1lb3V0X3N0YWxlX2tleShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBJbiB0aGlzIGNhc2UgYSBrZXkgaGFzIGEgdGltZSB0byBsaXZlIGluIHRoZSBwYXN0IGFuZCBzaG91bGQgcmV0dXJuIE5PVCBGT1VORC4KICAgICAgICAiIiIKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ1RFU1QxJ10gPSAoJ3R0bCcsIGRhdGV0aW1lLm5vdygpIC0gdGltZWRlbHRhKGRheXM9MTApLCkKICAgICAgICBuY2FjaGUuY2FjaGVfdmFsdWVzWydURVNUMSddID0gJ3NvbWUgdGVzdCBkYXRhJwoKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnVEVTVDEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ05PVCBGT1VORCcpCgogICAgZGVmIHRlc3RfZ2V0X29yX3RpbWVvdXRfcGVybV9rZXkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgSW4gdGhpcyBjYXNlIGEga2V5IGlzIHBlcm0gYW5kIHNob3VsZCByZXR1cm4gZGF0YS4KICAgICAgICAiIiIKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ1RFU1QxJ10gPSAoJ3Blcm0nLCBkYXRldGltZS5ub3coKSAtIHRpbWVkZWx0YShkYXlzPTEwKSwpCiAgICAgICAgbmNhY2hlLmNhY2hlX3ZhbHVlc1snVEVTVDEnXSA9ICdzb21lIHRlc3QgZGF0YScKCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ1RFU1QxJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCgoKY2xhc3MgVGVzdE5DYWNoZUNsZWFyS2V5cyh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAiIiIKICAgIE9jY2FzaW9uYWxseSBtZW1vcnkgbGltaXRzIHdpbGwgZm9yY2UgYSBjbGVhcm91dCBvZiB0dGwgZXhwaXJlZCBrZXlzIG9yIHBlcm0ga2V5cwoKICAgIFJ1bGVzIGZvciBjbGVhcmluZyBrZXlzLgoKICAgIDEuIENsZWFyIHRoZSBvbGRlc3QgY2h1bmsgb2YgcGVybSBrZXlzIHdoaWxlIGNhY2hlIGlzIHN0aWxsIGZ1bGwuCiAgICAyLiBJZiBhbGwgcGVybSBrZXlzIGhhdmUgYmVlbiBkZWxldGVkIGNsZWFyIHR0bCBrZXlzIHRoYXQgd2lsbCBleHBpcmUgaW4gNSBtaW5zLgogICAgMy4gSWYgY2FjaGUgaXMgc3RpbGwgZnVsbCBpbmNyZWFzZSBleHBpcmUgdGltZSBieSA1IG1pbnMgYW5kIGNsZWFyIHR0bCBrZXlzLAogICAgICAgcmVwZWF0IHRoaXMgc3RlcCB1bnRpbCBjYWNoZSBpcyBjbGVhci4KCgogICAgIiIiCiAgICBkZWYgdGVzdF9jbGVhcl9wZXJtX2tleXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgR2l2ZW4gdGhlIGZvbGxvd2luZwoKICAgICAgICB8IGtleSB8IHRpbWVvdXQgdHlwZSB8ICAgIGRhdGUgICAgICB8CiAgICAgICAgKy0tLS0tKy0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tKwogICAgICAgIHwnazEnIHwgICAgJ3Blcm0nICAgIHwgbm93IC0gMTAwc2VjIHwKICAgICAgICB8J2syJyB8ICAgICdwZXJtJyAgICB8IG5vdyAtIDIwMHNlYyB8CiAgICAgICAgfCdrMycgfCAgICAncGVybScgICAgfCBub3cgLSAxMHNlYyAgfAoKICAgICAgICBvcmRlciBvZiBkZWxldGlvbiBzaG91bGQgYmUgazIsIHRoZW4gazEsIHRoZW4gazMKICAgICAgICAiIiIKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ2sxJ10gPSAoJ3Blcm0nLCBkYXRldGltZS5ub3coKSAtIHRpbWVkZWx0YShzZWNvbmRzPTEwMCksKQogICAgICAgIG5jYWNoZS5jYWNoZV92YWx1ZXNbJ2sxJ10gICA9ICdzb21lIHRlc3QgZGF0YScKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ2syJ10gPSAoJ3Blcm0nLCBkYXRldGltZS5ub3coKSAtIHRpbWVkZWx0YShzZWNvbmRzPTIwMCksKQogICAgICAgIG5jYWNoZS5jYWNoZV92YWx1ZXNbJ2syJ10gICA9ICdzb21lIHRlc3QgZGF0YScKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ2szJ10gPSAoJ3Blcm0nLCBkYXRldGltZS5ub3coKSAtIHRpbWVkZWx0YShzZWNvbmRzPTEwKSwpCiAgICAgICAgbmNhY2hlLmNhY2hlX3ZhbHVlc1snazMnXSAgID0gJ3NvbWUgdGVzdCBkYXRhJwoKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazInKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazMnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKCiAgICAgICAgbmNhY2hlLl9jbGVhcl9wZXJtX2tleXMoMSkKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazInKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ05PVCBGT1VORCcpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2szJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCgogICAgICAgIG5jYWNoZS5fY2xlYXJfcGVybV9rZXlzKDEpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2sxJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdOT1QgRk9VTkQnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMicpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnTk9UIEZPVU5EJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazMnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKCiAgICAgICAgbmNhY2hlLl9jbGVhcl9wZXJtX2tleXMoMSkKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ05PVCBGT1VORCcpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2syJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdOT1QgRk9VTkQnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnTk9UIEZPVU5EJykKCiAgICBkZWYgdGVzdF9jbGVhcl90dGxfa2V5cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBHaXZlbiB0aGUgZm9sbG93aW5nCgogICAgICAgIHwga2V5IHwgdGltZW91dCB0eXBlIHwgICAgZGF0ZSAgICAgIHwKICAgICAgICArLS0tLS0rLS0tLS0tLS0tLS0tLS0rLS0tLS0tLS0tLS0tLS0rCiAgICAgICAgfCdrMScgfCAgICAndHRsJyAgICB8IG5vdyArIDM2MHNlYyAgfAogICAgICAgIHwnazInIHwgICAgJ3R0bCcgICAgfCBub3cgKyA2NDBzZWMgIHwKICAgICAgICB8J2szJyB8ICAgICd0dGwnICAgIHwgbm93ICsgNzIwc2VjICB8CgogICAgICAgIHN0ZXAgNSBtaW5zIG9yIDMwMCBzZWNvbmRzIGZvcndhcmQgdG8gcmVtb3ZlIG5vIGtleXMKICAgICAgICBzdGVwIDUgbWlucyBvciAzMDAgc2Vjb25kcyBmb3J3YXJkIHRvIHJlbW92ZSBrMQogICAgICAgIHN0ZXAgNSBtaW5zIG9yIDMwMCBzZWNvbmRzIGZvcndhcmQgdG8gcmVtb3ZlIGszIGFuZCBrMgogICAgICAgICIiIgogICAgICAgIG5jYWNoZS5jYWNoZV90aW1lb3V0c1snazEnXSA9ICgndHRsJywgZGF0ZXRpbWUubm93KCkgKyB0aW1lZGVsdGEoc2Vjb25kcz0zNjApLCkKICAgICAgICBuY2FjaGUuY2FjaGVfdmFsdWVzWydrMSddICAgPSAnc29tZSB0ZXN0IGRhdGEnCiAgICAgICAgbmNhY2hlLmNhY2hlX3RpbWVvdXRzWydrMiddID0gKCd0dGwnLCBkYXRldGltZS5ub3coKSArIHRpbWVkZWx0YShzZWNvbmRzPTY0MCksKQogICAgICAgIG5jYWNoZS5jYWNoZV92YWx1ZXNbJ2syJ10gICA9ICdzb21lIHRlc3QgZGF0YScKICAgICAgICBuY2FjaGUuY2FjaGVfdGltZW91dHNbJ2szJ10gPSAoJ3R0bCcsIGRhdGV0aW1lLm5vdygpICsgdGltZWRlbHRhKHNlY29uZHM9NzIwKSwpCiAgICAgICAgbmNhY2hlLmNhY2hlX3ZhbHVlc1snazMnXSAgID0gJ3NvbWUgdGVzdCBkYXRhJwoKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazInKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazMnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKCiAgICAgICAgZnV0dXJlID0gZGF0ZXRpbWUubm93KCkgKyB0aW1lZGVsdGEoc2Vjb25kcz0zMDApCiAgICAgICAgbmNhY2hlLl9jbGVhcl90dGxfa2V5cyhmdXR1cmUpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2sxJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2syJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2szJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCgogICAgICAgIGZ1dHVyZSA9IGZ1dHVyZSArIHRpbWVkZWx0YShzZWNvbmRzPTMwMCkKICAgICAgICBuY2FjaGUuX2NsZWFyX3R0bF9rZXlzKGZ1dHVyZSkKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ05PVCBGT1VORCcpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2syJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2szJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lIHRlc3QgZGF0YScpCgogICAgICAgIGZ1dHVyZSA9IGZ1dHVyZSArIHRpbWVkZWx0YShzZWNvbmRzPTMwMCkKICAgICAgICBuY2FjaGUuX2NsZWFyX3R0bF9rZXlzKGZ1dHVyZSkKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ05PVCBGT1VORCcpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2syJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdOT1QgRk9VTkQnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnTk9UIEZPVU5EJykKCgpjbGFzcyBUZXN0TkNhY2hlU2V0S2V5cyh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAiIiIKICAgIFdoZW4gYSBjYWNoZSBrZXkgaXMgc2V0LCBpdHMgc2V0LiAgWW91IGNhbiBnZXQgaXQgYmFjayBvdXQgcHJvdmlkZWQgaXQgaXMgbm90IGV4cGlyZWQhCgogICAgV2UgY2FuIGFzc2VydCB0aGUga2V5IGlzIHByZXNlbnQgaW4gYm90aCB0aGUgdmFsdWVzIGFuZCB0aW1lb3V0IGNhY2hlcy4KICAgIFdlIGNhbiBhc3NlcnQgdGhlIGtleSBob2xkcyB0aGUgY29ycmVjdCBkYXRhLgogICAgV2UgY2FuIG5ldmVyIGJlIGFic29sdXRlbHkgY2VydGFpbiBhYm91dCB0aGUgZXhwaXJ5IHRpbWUsIGJ1dCBpdHMgY2xvc2UuCiAgICAiIiIKICAgIGRlZiB0ZXN0X3NldF9rZXlfcGVybShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBc3NlcnQgJ2sxJyAtPiAnc29tZV90ZXN0X2RhdGEnIGluIG5jYWNoZS5jYWNoZV92YWx1ZXMKICAgICAgICBBc3NlcnQgJ2sxJyAtPiAoJ3Blcm0nLCA8ZGF0ZXRpbWU+KQogICAgICAgICIiIgogICAgICAgIG5jYWNoZS5fc2V0X2tleSgnazEnLCAnc29tZV90ZXN0X2RhdGEnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuY2FjaGVfdGltZW91dHMuZ2V0KCdrMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhWzBdLCAncGVybScpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGlzaW5zdGFuY2UoZGF0YVsxXSwgZGF0ZXRpbWUpKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShib29sKGRhdGV0aW1lLm5vdygpID49IGRhdGFbMV0pKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnc29tZV90ZXN0X2RhdGEnKQogICAgICAgICMgcmVwZWF0IHRlc3QgdG8gZ3VhcmQgYWdhaW5zdCBhY2NpZGVudGFsIHJlbW92YWwgdXNpbmcgcG9wIGluc3RlYWQgb2YgZ2V0IDotJAogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnc29tZV90ZXN0X2RhdGEnKQoKICAgIGRlZiB0ZXN0X3NldF9rZXlfdHRsKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEFzc2VydCAnazEnIC0+ICdzb21lX3Rlc3RfZGF0YScgaW4gbmNhY2hlLmNhY2hlX3ZhbHVlcwogICAgICAgIEFzc2VydCAnazEnIC0+ICgndHRsJywgPGRhdGV0aW1lICsgMjAwMHNlY29uZHM+KQogICAgICAgICIiIgogICAgICAgIG5jYWNoZS5fc2V0X2tleSgnazEnLCAnc29tZV90ZXN0X2RhdGEnLCB0dGw9MjAwMCkKICAgICAgICAjWFhYOiBob3BlZnVsbHkgdGhpcyB0ZXN0IHdpbGwgbm90IHN0YWxsIG92ZXIgMjAwMHNlY29uZHMuICBJdCB3b3VsZG4ndCBpbiBwdXJlIHB5dGhvbiBvdXRzaWRlIG9mIHF1YXJ0egogICAgICAgIGRhdGEgPSBuY2FjaGUuY2FjaGVfdGltZW91dHMuZ2V0KCdrMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhWzBdLCAndHRsJykKICAgICAgICBzZWxmLmFzc2VydFRydWUoaXNpbnN0YW5jZShkYXRhWzFdLCBkYXRldGltZSkpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGJvb2woZGF0ZXRpbWUubm93KCkgPD0gZGF0YVsxXSkpCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2sxJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lX3Rlc3RfZGF0YScpCiAgICAgICAgIyByZXBlYXQgdGVzdCB0byBndWFyZCBhZ2FpbnN0IGFjY2lkZW50YWwgcmVtb3ZhbCB1c2luZyBwb3AgaW5zdGVhZCBvZiBnZXQgOi0kCiAgICAgICAgZGF0YSA9IG5jYWNoZS5fZ2V0X29yX3RpbWVvdXQoJ2sxJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdzb21lX3Rlc3RfZGF0YScpCgogICAgZGVmIHRlc3Rfc2V0X2tleV90dGxfZXhwaXJ5KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEFzc2VydCAnazEnIC0+ICdzb21lX3Rlc3RfZGF0YScgaW4gbmNhY2hlLmNhY2hlX3ZhbHVlcwogICAgICAgIEFzc2VydCAnazEnIC0+ICgndHRsJywgPGRhdGV0aW1lICsgMHNlY29uZHM+KQogICAgICAgICIiIgogICAgICAgIG5jYWNoZS5fc2V0X2tleSgnazEnLCAnc29tZV90ZXN0X2RhdGEnLCB0dGw9MCkKICAgICAgICBkYXRhID0gbmNhY2hlLmNhY2hlX3RpbWVvdXRzLmdldCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YVswXSwgJ3R0bCcpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGlzaW5zdGFuY2UoZGF0YVsxXSwgZGF0ZXRpbWUpKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShib29sKGRhdGV0aW1lLm5vdygpID49IGRhdGFbMV0pKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMScpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnTk9UIEZPVU5EJykKCgpjbGFzcyBUZXN0TkNhY2hlUGFyc2VDb21tYW5kKHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICIiIgogICAgRm9sbG93aW5nIHRoZSBzaW1wbGljaXR5IG9mIG1lbWNhY2hlZCwgdGhlcmUgYXJlIHR3byBjb21tYW5kcy4gU0VUIGFuZCBHRVQuCgogICAgU3ludGF4IGlzLgoKICAgIFNFVCA8S0VZX05BTUU+ICI8VkFMVUU+IiBUVEw9PGludD4KICAgICAgICAtIEtleSBuYW1lcyBDQU5OT1QgaGF2ZSBzcGFjZXMuIFRUTCBpcyBvcHRpb25hbC4KCiAgICBHRVQgPEtFWV9OQU1FPgogICAgICAgIC0gS2V5IG5hbWVzIENBTk5PVCBoYXZlIHNwYWNlcwogICAgIiIiCiAgICBkZWYgdGVzdF9wYXJzZV9jb21tYW5kX3NldChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBCZWhhdmlvdXIgb2YgdGhlIHNldCBjb21tYW5kIGlzIHJlcHJlc2VudGVkIGJlbG93LgoKICAgICAgICB8ICAgY29tbWFuZCAgICAgICAgICAgICAgIHwgIEV4cGVjdGVkICAgICAgICAgICAgICB8CiAgICAgICAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwogICAgICAgIHwgU0VUIGsxICJzb21lIHRlc3QgZGF0YSIgfCBrMSAtPiAic29tZSB0ZXN0IGRhdGEiIHwKICAgICAgICB8IFNFVCBrMiAic29tZSB0ZXN0IGRhdGEiIHwgazIgLT4gInNvbWUgdGVzdCBkYXRhIiB8CiAgICAgICAgfCBTRVQgazIgbW9yZSB0ZXN0IGRhdGEgICB8IGsyIC0+ICJtb3JlIHRlc3QgZGF0YSIgfAogICAgICAgIHwgU0VUIGszICJtZSAiIFRUTD0yMCAgICAgfCBrMyAtPiAibWUgIiAgICAgICAgICAgIHwKICAgICAgICB8IFNFVCBrNCAgICAgICAgICAgICAgICAgIHwgRXhjZXB0aW9uIC0gd3JvbmcgYXJncyB8CiAgICAgICAgfCBTRVQgICAgICAgICAgICAgICAgICAgICB8IEV4Y2VwdGlvbiAtIHdyb25nIGFyZ3MgfAogICAgICAgICIiIgogICAgICAgIHN0YXR1cyA9IG5jYWNoZS5wYXJzZV9jb21tYW5kKCdTRVQgazEgInNvbWUgdGVzdCBkYXRhIicpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzdGF0dXMsICdTVUNDRVNTJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazEnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ3NvbWUgdGVzdCBkYXRhJykKCiAgICAgICAgc3RhdHVzID0gbmNhY2hlLnBhcnNlX2NvbW1hbmQoJ1NFVCBrMiAic29tZSB0ZXN0IGRhdGEiJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHN0YXR1cywgJ1NVQ0NFU1MnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMicpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnc29tZSB0ZXN0IGRhdGEnKQoKICAgICAgICBzdGF0dXMgPSBuY2FjaGUucGFyc2VfY29tbWFuZCgnU0VUIGsyIG1vcmUgdGVzdCBkYXRhJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHN0YXR1cywgJ1NVQ0NFU1MnKQogICAgICAgIGRhdGEgPSBuY2FjaGUuX2dldF9vcl90aW1lb3V0KCdrMicpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChkYXRhLCAnbW9yZSB0ZXN0IGRhdGEnKQoKICAgICAgICBzdGF0dXMgPSBuY2FjaGUucGFyc2VfY29tbWFuZCgnU0VUIGszICJtZSAiIFRUTD0yMCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzdGF0dXMsICdTVUNDRVNTJykKICAgICAgICBkYXRhID0gbmNhY2hlLl9nZXRfb3JfdGltZW91dCgnazMnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZGF0YSwgJ21lICcpCgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoVmFsdWVFcnJvcik6CiAgICAgICAgICAgIG5jYWNoZS5wYXJzZV9jb21tYW5kKCdTRVQgazQnKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoVmFsdWVFcnJvcik6CiAgICAgICAgICAgIG5jYWNoZS5wYXJzZV9jb21tYW5kKCdTRVQnKQoKICAgIGRlZiB0ZXN0X3BhcnNlX2NvbW1hbmRfZ2V0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEJlaGF2aW91ciBvZiB0aGUgc2V0IGNvbW1hbmQgaXMgcmVwcmVzZW50ZWQgYmVsb3cuCgogICAgICAgIHwgICBjb21tYW5kICAgICAgICAgICAgICAgfCAgRXhwZWN0ZWQgICAgICAgICAgICAgIHwKICAgICAgICArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rCiAgICAgICAgfCBTRVQgazMgIm1lICIgICAgICAgICAgICB8IGszIC0+ICJtZSAiICAgICAgICAgICAgfAogICAgICAgIHwgR0VUIHRoaW5nICAgICAgICAgICAgICAgfCBOT1QgRk9VTkQgICAgICAgICAgICAgIHwKICAgICAgICB8IEdFVCBrMyAgICAgICAgICAgICAgICAgIHwgIm1lICIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgfCBHRVQgICAgICAgICAgICAgICAgICAgICB8IEV4Y2VwdGlvbiAtIHdyb25nIGFyZ3MgfAogICAgICAgIHwgR0VUIG15IGhlYWQgICAgICAgICAgICAgfCBFeGNlcHRpb24gLSB3cm9uZyBhcmdzIHwKICAgICAgICAiIiIKICAgICAgICBzdGF0dXMgPSBuY2FjaGUucGFyc2VfY29tbWFuZCgnU0VUIGszICJtZSAiJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHN0YXR1cywgJ1NVQ0NFU1MnKQogICAgICAgIGRhdGEgPSBuY2FjaGUucGFyc2VfY29tbWFuZCgnR0VUIHRoaW5nJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdOT1QgRk9VTkQnKQogICAgICAgIGRhdGEgPSBuY2FjaGUucGFyc2VfY29tbWFuZCgnR0VUIGszJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGRhdGEsICdtZSAnKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKFZhbHVlRXJyb3IpOgogICAgICAgICAgICBuY2FjaGUucGFyc2VfY29tbWFuZCgnR0VUJykKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0UmFpc2VzKFZhbHVlRXJyb3IpOgogICAgICAgICAgICBuY2FjaGUucGFyc2VfY29tbWFuZCgnR0VUIG15IGhlYWQnKQoKCmRlZiBtYWluKCk6CiAgICBzdWl0ZSA9IHVuaXR0ZXN0LlRlc3RTdWl0ZSgpCiAgICBzdWl0ZS5hZGRUZXN0KHVuaXR0ZXN0Lm1ha2VTdWl0ZShUZXN0TkNhY2hlR2V0T3JUaW1lb3V0KSkKICAgIHN1aXRlLmFkZFRlc3QodW5pdHRlc3QubWFrZVN1aXRlKFRlc3ROQ2FjaGVQYXJzZUNvbW1hbmQpKQogICAgc3VpdGUuYWRkVGVzdCh1bml0dGVzdC5tYWtlU3VpdGUoVGVzdE5DYWNoZUNsZWFyS2V5cykpCiAgICBzdWl0ZS5hZGRUZXN0KHVuaXR0ZXN0Lm1ha2VTdWl0ZShUZXN0TkNhY2hlU2V0S2V5cykpCiAgICB1bml0dGVzdC5UZXh0VGVzdFJ1bm5lcigpLnJ1bihzdWl0ZSkK
aW1wb3J0IGNQaWNrbGUKZnJvbSAgIGZ1bmN0b29scyBpbXBvcnQgd3JhcHMKZnJvbSAgIGhhc2hsaWIgaW1wb3J0IHNoYTEKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHJlCmltcG9ydCBzb2NrZXQKaW1wb3J0IHdhcm5pbmdzCgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmRlZiBmdW5jMmtleShmdW5jLCAqYXJncywgKiprdyk6CiAgICAiIiIKICAgIENvbnZlcnQgYSBmdW5jdGlvbiBhbmQgaXRzIGFyZ3VtZW50cyB0byBhIGNhY2hlIGtleS4KICAgICIiIgogICAga3cgPSBrdy5pdGVtcygpICMgZGljdHMgaGF2ZSBubyBvcmRlciBzbyBjb252ZXJ0aW5nIHRvIGEgbGlzdCBvZiB0dXBsZXMgYW5kIHNvcnQKICAgIGt3LnNvcnQoKQogICAgcmV0dXJuIHNoYTEoJyVzXyVzXyVzJyAlIChmdW5jLl9fbmFtZV9fLCBhcmdzLCBrdykpLmhleGRpZ2VzdCgpCgpjbGFzcyBOQ2FjaGUob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpcD0nMTI3LjAuMC4xJywgcG9ydD01MDA1LCBidWZmZXI9MTAyNCwga2V5X3JleHA9Iltcd1xkLV17Mix9IiwgcGlja2xlZD1UcnVlKToKICAgICAgICAiIiIKICAgICAgICBDcmVhdGUgYSBjYWNoZSBvYmplY3QgYm91bmQgdG8gYSBsb2NhdGlvbiBpbiBzYW5kcmEuICBJZiB0aGUgbG9jYXRpb24gZG9lcyBub3QgZXhpc3QgdGhlbiBpdCBpcyBjcmVhdGVkLgoKICAgICAgICA6cGFyYW0gc3RyIGxvY2F0aW9uOiBUaGUgZGVmYXVsdCBzYW5kcmEgbG9jYXRpb24gZm9yIHRoaXMgY2FjaGUgb2JqZWN0IHRvIHN0b3JlIGtleXMuCiAgICAgICAgOnBhcmFtIHN0ciBkYl9uYW1lOiBUaGUgbmFtZSBvZiB0aGUgZGF0YWJhc2UgeW91IHdpc2ggdG8gY29ubmVjdCB0b28KCiAgICAgICAgdXNhZ2U6CiAgICAgICAgICAgID4+PiBteV9jYWNoZSA9IENhY2hlKGxvY2F0aW9uPSIvUmlzay9FbWVyYWxkL1BubC9SZXBvcnRzIiwgZGJfbmFtZT0ncmlza19lbWVyYWxkJykKICAgICAgICAgICAgPj4+IG15X2NhY2hlLnNldCgnUG5sLUNsaWVudHMnLCBwbmxfYWRhcHRlci5nZXRfY2xpZW50cygpKQogICAgICAgICAgICA+Pj4gbXlfY2FjaGUuZ2V0KCdQbmwtQ2xpZW50cycpCiAgICAgICAgICAgIHBubCBkYXRhLi4uCiAgICAgICAgIiIiCiAgICAgICAgc3VwZXIoTkNhY2hlLCBzZWxmKS5fX2luaXRfXygpCiAgICAgICAgc2VsZi5jb25uID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgIHNlbGYuY29ubi5jb25uZWN0KChpcCwgcG9ydCwpKQogICAgICAgIHNlbGYuYnVmZmVyX3NpemUgPSBidWZmZXIKICAgICAgICBzZWxmLnBpY2tsZWQgPSBwaWNrbGVkCiAgICAgICAgc2VsZi5fX3JleHAgPSByZS5jb21waWxlKGtleV9yZXhwKQogICAgICAgIHNlbGYuX19rZXlfcmV4cCA9IGtleV9yZXhwCgogICAgZGVmIF9leGVjdXRlX2NvbW1hbmQoc2VsZiwgY29tbWFuZCk6CiAgICAgICAgIiIiCiAgICAgICAgRXhlY3V0ZSB0aGUgY29uc3RydWN0ZWQgY29tbWVuZCBhbmQgaGFuZGxlIHRoZSByZXNwb25zZS4KICAgICAgICAiIiIKICAgICAgICBzZWxmLmNvbm4uc2VuZChjb21tYW5kKQogICAgICAgIHJlc3BvbnNlID0gc2VsZi5jb25uLnJlY3Yoc2VsZi5idWZmZXJfc2l6ZSkKICAgICAgICBpZiByZXNwb25zZS5zdGFydHN3aXRoKCdFUlJPUjogJyk6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocmVzcG9uc2UpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlCgogICAgZGVmIGNhY2hhYmxlKHNlbGYsIGtleV9uYW1lPU5vbmUsIHNlY29uZHM9Tm9uZSwgb3ZlcndyaXRlPVRydWUsIGNhY2hlX3VudGlsPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIERlY29yYXRlIGFuIGV4cGVuc2l2ZSBjYWxjdWxhdGlvbiB0byBzYXZlIG9uIGNvbXB1dGluZy4gQWxsIHZhbHVlcyBhcmUKICAgICAgICBwaWNrbGVkIGJlZm9yZSBiZWluZyBzdG9yZWQuIEtleXMgbWF5IGJlIGhhc2hlZCBmb3Igc29tZSBzZWN1cml0eS4gVGhlIG1heQogICAgICAgIGJlIHByZWZpeGVkIGZvciBlYXN5IGxvb2t1cHMuCiAgICAgICAgTm90ZSAtIE9ubHkgY2FjaGUgbW9kdWxlIG1ldGhvZHMuIFRvIGNhY2hlIGNsYXNzIG1ldGhvZHMsIHNwZWNpZnkgYSBrZXlfbmFtZS4KICAgICAgICAgICAgICAgIEFkZGl0aW9uYWwgZml4L3N1cHBvcnQgaXMgbmVlZGVkIGZvciBjYWNoaW5nIGNsYXNzIG1ldGhvZHMKCiAgICAgICAgOnBhcmFtIHN0ciBrZXlfbmFtZTogVGhlIHNwZWNpZmljIG5hbWUgZm9yIHRoaXMga2V5LiBJZiBvbWl0dGVkIHRoaXMga2V5IHdpbGwgYmUgbWFkZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBuYW1lIGFuZCBhIGxpc3Qgb2YgaXRzIGFyZ3MuCiAgICAgICAgOnBhcmFtIGludCBzZWNvbmRzOiBUaGUgZXhwaXJ5IHRpbWUgb2YgdGhpcyBrZXkKICAgICAgICA6cGFyYW0gYm9vbCBvdmVyd3JpdGU6IEEgZmxhZyB0byBzZXQgd2hldGhlciBhIGtleSBtYXkgYmUgb3ZlcndyaXR0ZW4KICAgICAgICA6cGFyYW0gZGF0ZXRpbWUuZGF0ZXRpbWUgY2FjaGVfdW50aWw6IERhdGV0aW1lIHRoYXQgdGhpcyBrZXkgd2lsbCBleHBpcmUgb24KCiAgICAgICAgVXNhZ2U6CiAgICAgICAgICAgID4+PiBjYWNoZSA9IENhY2hlKCkKICAgICAgICAgICAgPj4+IEBjYWNoZS5jYWNoYWJsZSgpCiAgICAgICAgICAgICAgICBkZWYgYWRkaXQoYSwgYik6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGErYgogICAgICAgICIiIgogICAgICAgIGRlZiBjb2xsZWN0KGYpOgogICAgICAgICAgICAjIHVzaW5nIGZ1bmN0b29scy53cmFwIGFsbG93cyBhbGwgZnVuYyBwYXJhbWV0cmVzIHRvIGJlIHBhc3NlZCB0byB0aGlzIGRlY29yYXRvcgogICAgICAgICAgICAjIHdoaWxlIHByZXNlcnZpbmcgdGhlIGRvYyBzdHJpbmdzIGFuZCBvdGhlciBtZXRhIGRhdGEuCiAgICAgICAgICAgIEB3cmFwcyhmKQogICAgICAgICAgICBkZWYgZG9fY2FjaGluZygqYXJncywgKiprdyk6CiAgICAgICAgICAgICAgICAjIGtleSBpcyBoYXNoZWQgYnkgZnVuYzJrZXkKICAgICAgICAgICAgICAgIGtleSA9IGZ1bmMya2V5KGYsICphcmdzLCAqKmt3KSBpZiBrZXlfbmFtZSBpcyBOb25lIGVsc2Uga2V5X25hbWUKICAgICAgICAgICAgICAgIHZhbHVlID0gc2VsZi5nZXQoa2V5LCBoYXNoPUZhbHNlKQogICAgICAgICAgICAgICAgaWYgbm90IHZhbHVlOiAjIElmIHZhbHVlIGlzIG5vbmUgbm90aGluZyBleGlzdHMgYW5kIHdlIG11c3QgY2FsbCB0aGUgZGVjb3JhdGVkIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBmKCphcmdzLCAqKmt3KQogICAgICAgICAgICAgICAgICAgIGlmIHZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICMgWW91IHNob3VsZG4ndCBkZWNvcmF0ZSBmdWN0aW9ucyB0aGF0IHJldHJ1biBOb25lIHdpdGggYSBjYWNoZSBkZWNvcmF0b3IuCiAgICAgICAgICAgICAgICAgICAgICAgICMgVGhlIHdhcm5pbmcgaXMgaGVscGZ1bGx5IHByaW50ZWQgYmVmb3JlIHRoZSByYWlzZSBzdGF0ZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgICAgIHdhcm5pbmdzLndhcm4oIiIiCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVjb3JhdGVkIGZ1bmN0aW9uIG11c3QgZXhpdCB1c2luZyB0aGUgcmV0dXJuIGtleXdvcmQgYW5kIG11c3QgTk9UIHJldHVybiBOb25lLgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEluc3RlYWQgcmV0dXJuIHNvbWV0aGluZyBzaW1pbGFyIGJ1dCBtZWFuaW5nZnVsIGluIHRoZSBjb250ZXh0IG9mIHlvdXIgZnVuY3Rpb24gZWc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXSwge30sIDAsIEZhbHNlLCBzdHIoIk5vbmUiKSwgc3RyKCJObyByZWNvcmRzIikgZXRjLiIiIikKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdOb25lVHlwZSBpcyBub3QgY2FjaGFibGUuIElmIHJlcXVpcmVkIE5vbmUgY2FuIGJlIGNhY2hlZCB1c2luZyBDYWNoZS5zZXQoKScpCgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0KGtleSwgdmFsdWUsIHNlY29uZHM9c2Vjb25kcykKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgICAgICByZXR1cm4gZG9fY2FjaGluZwogICAgICAgIHJldHVybiBjb2xsZWN0CgogICAgZGVmIF9fdmFsaWRhdGVfa2V5KHNlbGYsIGtleSk6CiAgICAgICAgIiIiCiAgICAgICAgRW5zdXJlcyBhIGtleSBuYW1lIHBhc3NlcyB0aGUgcmVnZXggY2hlY2sgd2l0aCBleHByZXNzaW9uIGluIHNlbGYuX19rZXlfcmV4cAogICAgICAgIFJhaXNlcyBhbmQgZXhjZXB0aW9uIGlmIHRoZSBrZXkgY2Fubm90IHBhc3MgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiBjaGVjay4KCiAgICAgICAgOnBhcmFtIHN0ciBrZXk6IEEga2V5IG5hbWUuCiAgICAgICAgIiIiCiAgICAgICAgaXNfbWF0Y2ggPSBzZWxmLl9fcmV4cC5tYXRjaChrZXkpCiAgICAgICAgaWYgbm90IGlzX21hdGNoIG9yIGlzX21hdGNoLmdyb3VwKCkgaXMgbm90IGtleToKICAgICAgICAgICAgcmFpc2UgS2V5RXJyb3IoJyIlcyIgaXMgYW4gaW52YWxpZCBrZXkgYXMgaXQgZG9lcyBub3QgbWF0Y2ggd2l0aCB0aGUgZm9sbG93aW5nIHJlZ3VsYXIgZXhwcmVzc2lvbiwgJXMnJShrZXksIHNlbGYuX19rZXlfcmV4cCkpCiAgICAgICAgcmV0dXJuIGtleQoKICAgIGRlZiBzZXQoc2VsZiwga2V5LCB2YWx1ZSwgc2Vjb25kcz1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBTZXQgYSBrZXkgaW4gdGhlIGNhY2hlLgoKICAgICAgICA6cGFyYW0gc3RyIGtleTogVGhlIHNwZWNpZmljIG5hbWUgZm9yIHRoaXMga2V5LgogICAgICAgIDpwYXJhbSBvYmplY3QgdmFsdWU6IFRoZSBvYmplY3QgdG8gYmUgY2FjaGVkLgogICAgICAgIDpwYXJhbSBpbnQgc2Vjb25kczogVGhlIGV4cGlyeSB0aW1lIG9mIHRoaXMga2V5LgogICAgICAgICIiIgogICAgICAgIGtleSA9IHNlbGYuX192YWxpZGF0ZV9rZXkoa2V5KQogICAgICAgIGlmIHNlbGYucGlja2xlZDoKICAgICAgICAgICAgdmFsdWUgPSBjUGlja2xlLmR1bXBzKHZhbHVlKQogICAgICAgIHR0bCA9ICIiCiAgICAgICAgaWYgc2Vjb25kcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgdHRsID0gIlRUTD17MH0iLmZvcm1hdChzZWNvbmRzKQogICAgICAgIGNvbW1hbmQgPSAiU0VUIHswfSB7MX0gezJ9Ii5mb3JtYXQoa2V5LCB2YWx1ZSwgdHRsKQogICAgICAgIHJldHVybiBzZWxmLl9leGVjdXRlX2NvbW1hbmQoY29tbWFuZCkKCiAgICBkZWYgZ2V0KHNlbGYsIGtleSk6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGEga2V5IGZyb20gdGhlIGNhY2hlCgogICAgICAgIDpwYXJhbSBzdHIga2V5OiBUaGUgc3BlY2lmaWMgbmFtZSBmb3IgdGhpcyBrZXkuCiAgICAgICAgIiIiCiAgICAgICAga2V5ID0gc2VsZi5fX3ZhbGlkYXRlX2tleShrZXkpCiAgICAgICAgY29tbWFuZCA9ICJHRVQgezB9Ii5mb3JtYXQoa2V5KQogICAgICAgIHJlc3AgPSBzZWxmLl9leGVjdXRlX2NvbW1hbmQoY29tbWFuZCkKICAgICAgICBpZiByZXNwID09ICdOT1QgRk9VTkQnOgogICAgICAgICAgICByZXNwID0gTm9uZQogICAgICAgIGVsaWYgc2VsZi5waWNrbGVkOgogICAgICAgICAgICByZXNwID0gY1BpY2tsZS5sb2FkcyhyZXNwKQogICAgICAgIHJldHVybiByZXNwCgpkZWYgbWFpbigpOgogICAgYyA9IE5DYWNoZSgpCiAgICByZXNwID0gYy5zZXQoJ25pYWxsJywgMzYpCiAgICBwcmludCByZXNwCiAgICByZXNwID0gYy5nZXQoJ25pYWxsJykKICAgIHByaW50IHJlc3AKICAgIHJlc3AgPSBjLmdldCgnbmlhJykKICAgIHByaW50IHJlc3AKCg==